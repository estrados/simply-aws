{{define "vpc-panel"}}
<div id="vpc-content">
  {{template "vpc-content" .}}
</div>
{{end}}

{{define "vpc-content"}}
{{if not (hasVPCData .VPC)}}
  <div class="empty-state">No VPC data cached. Click the refresh button to sync from AWS.</div>
{{else}}
  {{$vpc := .VPC}}
  {{$region := .Region}}
  {{range .VPC.VPCs}}
  {{$vpcId := .VpcId}}
  {{$igws := igwsFor .VpcId $vpc}}
  {{$natgws := natgwsFor .VpcId $vpc}}
  {{$rts := routeTablesFor .VpcId $vpc}}
  {{$sgs := sgsFor .VpcId $vpc}}
  {{$lbs := lbsFor .VpcId $vpc}}

  <div class="vpc-card">
    <div class="vpc-header clickable" hx-get="/detail/vpc/{{.VpcId}}?region={{$region}}" hx-target="#detail-container" hx-swap="innerHTML">
      <div class="vpc-title">
        <span class="vpc-name">{{if .Name}}{{.Name}}{{else}}{{.VpcId}}{{end}}</span>
        {{if .IsDefault}}<span class="tag tag-default">default</span>{{end}}
        <span class="tag tag-{{.State}}">{{.State}}</span>
      </div>
      <div class="vpc-meta">
        <code>{{.VpcId}}</code>
        <span class="vpc-cidr">{{.CidrBlock}}</span>
      </div>
    </div>

    <div class="vpc-body">
      {{if $igws}}
      <div class="vpc-section">
        <div class="vpc-section-label">Internet Gateways <span class="count-badge">{{len $igws}}</span></div>
        {{range $igws}}
        <div class="resource-row clickable" hx-get="/detail/igw/{{.InternetGatewayId}}?region={{$region}}" hx-target="#detail-container" hx-swap="innerHTML">
          <span class="resource-icon resource-icon-igw">IGW</span>
          <span class="resource-name">{{if .Name}}{{.Name}}{{else}}{{.InternetGatewayId}}{{end}}</span>
          <code class="resource-id">{{.InternetGatewayId}}</code>
        </div>
        {{end}}
      </div>
      {{end}}

      {{if $natgws}}
      <div class="vpc-section">
        <div class="vpc-section-label">NAT Gateways <span class="count-badge">{{len $natgws}}</span></div>
        {{range $natgws}}
        <div class="resource-row clickable" hx-get="/detail/natgw/{{.NatGatewayId}}?region={{$region}}" hx-target="#detail-container" hx-swap="innerHTML">
          <span class="resource-icon resource-icon-nat">NAT</span>
          <span class="resource-name">{{if .Name}}{{.Name}}{{else}}{{.NatGatewayId}}{{end}}</span>
          <code class="resource-id">{{.NatGatewayId}}</code>
          <span class="tag tag-{{.State}}">{{.State}}</span>
        </div>
        {{end}}
      </div>
      {{end}}

      {{if $sgs}}
      <div class="vpc-section">
        <div class="vpc-section-label">Security Groups <span class="count-badge">{{len $sgs}}</span></div>
        {{range $sgs}}
        <div class="resource-row clickable" hx-get="/detail/sg/{{.GroupId}}?region={{$region}}" hx-target="#detail-container" hx-swap="innerHTML">
          <span class="resource-icon resource-icon-sg">SG</span>
          <span class="resource-name">{{if .Name}}{{.Name}}{{else}}{{.GroupName}}{{end}}</span>
          <span class="sg-rules">{{.InboundCount}} in / {{.OutboundCount}} out</span>
          <code class="resource-id">{{.GroupId}}</code>
        </div>
        {{end}}
      </div>
      {{end}}

      {{if $lbs}}
      {{range $lbs}}
      <div class="vpc-section rt-section">
        <div class="rt-header clickable" hx-get="/detail/lb/{{.Name}}?region={{$region}}" hx-target="#detail-container" hx-swap="innerHTML">
          <span class="resource-icon {{lbIconClass .Type}}">{{lbIcon .Type}}</span>
          <span class="tag tag-{{.State}}">{{.State}}</span>
          <span class="tag tag-{{.Scheme}}">{{.Scheme}}</span>
          <span class="resource-name">{{.Name}}</span>
        </div>
        <div class="rt-subnets">
          <div class="nested-section-label">DNS</div>
          <div class="endpoint-info">
            <div class="endpoint-row"><code class="endpoint-value">{{.DNSName}}</code></div>
          </div>
          {{$tgs := tgsForLB .Arn $vpc}}
          {{if $tgs}}
          <div class="nested-section-label">Target Groups</div>
          {{range $tgs}}
          <div class="resource-row clickable" hx-get="/detail/tg/{{.Name}}?region={{$region}}" hx-target="#detail-container" hx-swap="innerHTML">
            <span class="resource-icon resource-icon-tg">TG</span>
            <span class="resource-name">{{.Name}}</span>
            <span class="resource-detail">{{.Protocol}}:{{.Port}} · {{.TargetType}}</span>
          </div>
          {{end}}
          {{end}}
          {{if .SecurityGroups}}
          <div class="nested-section-label">Security Groups</div>
          {{range .SecurityGroups}}
          <div class="resource-row clickable" hx-get="/detail/sg/{{.}}?region={{$region}}" hx-target="#detail-container" hx-swap="innerHTML">
            <span class="resource-icon resource-icon-sg">SG</span>
            <span class="resource-name">{{.}}</span>
          </div>
          {{end}}
          {{end}}
        </div>
      </div>
      {{end}}
      {{end}}

      {{if $rts}}
      {{range $rts}}
      {{$access := rtAccess .}}
      {{$rtSubnets := subnetsForRT . $vpcId $vpc}}
      <div class="vpc-section rt-section">
        <div class="rt-header clickable" hx-get="/detail/rt/{{.RouteTableId}}?region={{$region}}" hx-target="#detail-container" hx-swap="innerHTML">
          <span class="resource-icon resource-icon-rt">RT</span>
          <span class="tag tag-{{$access}}">{{$access}}</span>
          {{if .IsMain}}<span class="tag tag-main">main</span>{{end}}
          <span class="resource-name">{{if .Name}}{{.Name}}{{else}}{{.RouteTableId}}{{end}}</span>
          <code class="resource-id">{{.RouteTableId}}</code>
          <span class="resource-detail">{{len .Routes}} routes</span>
        </div>

        {{if $rtSubnets}}
        <div class="rt-subnets">
          <div class="subnet-grid">
            {{range $rtSubnets}}
            <div class="subnet-card clickable" hx-get="/detail/subnet/{{.SubnetId}}?region={{$region}}" hx-target="#detail-container" hx-swap="innerHTML">
              <div class="subnet-name">{{if .Name}}{{.Name}}{{else}}{{.SubnetId}}{{end}}</div>
              <div class="subnet-details">
                <div><code>{{.CidrBlock}}</code></div>
                <div class="subnet-meta">{{.AvailabilityZone}} · {{.AvailableIPs}} IPs free</div>
              </div>
              <code class="subnet-id">{{.SubnetId}}</code>
            </div>
            {{end}}
          </div>
        </div>
        {{else}}
        <div class="rt-no-subnets">No subnets associated</div>
        {{end}}
      </div>
      {{end}}
      {{end}}
    </div>
  </div>
  {{end}}
{{end}}
{{end}}

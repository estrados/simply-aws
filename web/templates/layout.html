{{define "layout"}}<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>saws</title>
  <link rel="stylesheet" href="/static/styles.css">
  <script src="https://unpkg.com/htmx.org@2.0.4"></script>
</head>
<body>
  <header>
    <h1><span>saws</span></h1>
    <div id="header-right">
      <span id="synced-at-label" class="synced-at-label">{{.SyncedAt}}</span>
      <div class="sync-split">
        <button class="icon-btn" id="sync-btn"
          onclick="startSync(false)"
          title="Sync">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21.5 2v6h-6"/><path d="M2.5 22v-6h6"/><path d="M2.5 11.5a10 10 0 0 1 18.4-4.5"/><path d="M21.5 12.5a10 10 0 0 1-18.4 4.5"/>
          </svg>
        </button>
        <button class="icon-btn sync-chevron" onclick="this.parentElement.classList.toggle('open')" title="Sync options">
          <svg width="10" height="10" viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 4l4 4 4-4"/></svg>
        </button>
        <div class="sync-dropdown">
          <button class="sync-dropdown-item"
            onclick="this.closest('.sync-split').classList.remove('open'); startSync(true)">
            Sync all
          </button>
        </div>
      </div>
      <div id="region-select-wrapper">
        {{template "region-dropdown" .}}
      </div>
      <button class="icon-btn" hx-get="/settings/regions" hx-target="#panel-container" hx-swap="innerHTML" title="Region settings">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="2" r="2"/><path d="M12 8v13"/><path d="M5 3a2 2 0 1 0 0 4"/><path d="M5 7v13"/><path d="M19 3a2 2 0 1 1 0 4"/><path d="M19 7v13"/><path d="M2 21h20"/>
        </svg>
      </button>
      <button class="icon-btn" hx-get="/profile" hx-target="#panel-container" hx-swap="innerHTML" title="AWS profile">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
        </svg>
      </button>
    </div>
  </header>
  <main id="app">
    {{template "content" .}}
  </main>
  <div id="panel-container"></div>
  <div id="detail-container"></div>
  <script>
  (function() {
    var syncTab = "{{.Tab}}";
    var syncRegion = "{{.CurrentRegion}}";
    var syncTarget = {
      "net": "#vpc-content", "compute": "#compute-content",
      "s3": "#s3-content", "database": "#database-content",
      "iam": "#iam-content", "streaming": "#streaming-content",
      "ai": "#ai-content"
    };
    var syncEndpoint = {
      "net": "/sync/vpc", "compute": "/sync/compute",
      "s3": "/sync/s3", "database": "/sync/database",
      "iam": "/sync/iam", "streaming": "/sync/streaming",
      "ai": "/sync/ai"
    };
    var pollTimer = null;
    var savedSyncedAt = "";

    window.startSync = function(all) {
      var btn = document.getElementById("sync-btn");
      if (btn.classList.contains("htmx-request")) return;
      btn.classList.add("htmx-request");

      var label = document.getElementById("synced-at-label");
      savedSyncedAt = label.textContent;
      label.textContent = "syncing...";

      var endpoint = all ? "/sync/all" : (syncEndpoint[syncTab] || "/sync/all");
      var body = new URLSearchParams({region: syncRegion, tab: syncTab});

      fetch(endpoint, {method: "POST", body: body,
        headers: {"Content-Type": "application/x-www-form-urlencoded"}
      }).then(function(r) { return r.json(); })
      .then(function(data) {
        if (data.status === "running" || data.status === "done") {
          updateStatus(data);
          if (data.status === "running") startPolling(all);
          else onSyncDone(all);
        }
      }).catch(function() {
        btn.classList.remove("htmx-request");
        label.textContent = savedSyncedAt;
      });
    };

    function updateStatus(data) {
      var label = document.getElementById("synced-at-label");
      if (data.status === "running") {
        var text = "syncing";
        if (data.currentStep) text += " " + data.currentStep;
        text += "... (" + data.completed + ")";
        label.textContent = text;
      }
    }

    function startPolling(all) {
      if (pollTimer) return;
      pollTimer = setInterval(function() {
        fetch("/sync/progress").then(function(r) { return r.json(); })
        .then(function(data) {
          updateStatus(data);
          if (data.status !== "running") {
            onSyncDone(all);
          }
        });
      }, 500);
    }

    function onSyncDone(all) {
      if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
      var btn = document.getElementById("sync-btn");
      btn.classList.remove("htmx-request");

      var target = all ? "#app" : (syncTarget[syncTab] || "#app");
      var url = "/sync/content?tab=" + encodeURIComponent(syncTab) +
                "&region=" + encodeURIComponent(syncRegion);
      htmx.ajax("GET", url, {target: target, swap: "innerHTML"});
    }

    // Check if sync is already running on page load
    fetch("/sync/progress").then(function(r) { return r.json(); })
    .then(function(data) {
      if (data.status === "running") {
        var btn = document.getElementById("sync-btn");
        btn.classList.add("htmx-request");
        var label = document.getElementById("synced-at-label");
        savedSyncedAt = label.textContent;
        updateStatus(data);
        startPolling(false);
      }
    });
  })();
  </script>
</body>
</html>{{end}}
